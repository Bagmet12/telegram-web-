<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tesla Assistant</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen;
      background-color: #121212;
      color: white;
      padding: 20px;
    }
    .title {
      font-size: 22px;
      font-weight: bold;
    }
    .card, .form-card {
      background-color: #1e1e1e;
      border-radius: 12px;
      padding: 15px;
      margin-top: 15px;
      transition: 0.2s;
    }
    .card:hover, .form-card:hover {
      background-color: #2c2c2c;
    }
    input, textarea, button {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
    }
    button {
      background-color: #03c75a;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="title">–í—ñ—Ç–∞—î–º–æ, <span id="username">–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á</span>!</div>

  <div class="form-card">
    <h3>üìã –ó–∞—è–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤—ñ—Å</h3>

    <label for="vin">VIN –Ω–æ–º–µ—Ä</label>
    <input type="text" id="vin" placeholder="–í–≤–µ–¥—ñ—Ç—å VIN –∞–±–æ –ø—Ä–æ—Å–∫–∞–Ω—É–π—Ç–µ">
    <button onclick="scanVIN()">üì∑ –°–∫–∞–Ω—É–≤–∞—Ç–∏ VIN</button>

    <label for="template">–©–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –∑—Ä–æ–±–∏—Ç–∏?</label>
    <select id="template">
      <option value="checkup">–ó–∞–ø–∏—Å–∞—Ç–∏—Å—å –Ω–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫—É</option>
      <option value="report_error">–ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ –ø—Ä–æ –ø–æ–º–∏–ª–∫—É</option>
      <option value="pdf_request">–û—Ç—Ä–∏–º–∞—Ç–∏ PDF –∑–≤—ñ—Ç</option>
      <option value="status_request">–î—ñ–∑–Ω–∞—Ç–∏—Å—å —Å—Ç–∞—Ç—É—Å —Ä–µ–º–æ–Ω—Ç—É</option>
    </select>

    <label for="comment">–î–æ–¥–∞—Ç–∫–æ–≤–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä</label>
    <textarea id="comment" placeholder="–û–ø–∏—à—ñ—Ç—å –ø—Ä–æ–±–ª–µ–º—É –∞–±–æ –∑–∞–ª–∏—à—Ç–µ –∫–æ–º–µ–Ω—Ç–∞—Ä"></textarea>

    <button onclick="sendRequest()">üì© –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞—è–≤–∫—É</button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // –ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —ñ–º–µ–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    const username = tg.initDataUnsafe?.user?.first_name || tg.initDataUnsafe?.user?.username || "–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á";
    document.getElementById("username").innerText = username;

    function scanVIN() {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          alert("–ó–∞–ø—É—â–µ–Ω–∞ –∫–∞–º–µ—Ä–∞. –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å–∫–∞–Ω–µ—Ä–∞ –ø–æ—Ç—Ä–µ–±—É—î —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó –∑ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–æ—é —Ç–∏–ø—É QuaggaJS.");
          // –¢—É—Ç –±—É–¥–µ –ª–æ–≥—ñ–∫–∞ –∑ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–æ—é —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è (–æ–ø—Ç–∏—á–Ω–æ —Ä–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ VIN)
        })
        .catch(() => alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏. –î–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –±—Ä–∞—É–∑–µ—Ä–∞/Telegram."));
    }

    function sendRequest() {
      const vin = document.getElementById('vin').value.trim();
      const issue = document.getElementById('template').value + ': ' + document.getElementById('comment').value.trim();
      if (!vin || vin.length < 17) {
        alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –¥—ñ–π—Å–Ω–∏–π VIN (17 —Å–∏–º–≤–æ–ª—ñ–≤)");
        return;
      }

      const data = {
        vin,
        issue,
        user: username
      };

      fetch("https://tesla-service-dashboard-eda44e4816de.herokuapp.com/api/save_request", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(json => {
        if (json.status === "ok") {
          alert("–ó–∞—è–≤–∫—É –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ!");
        } else {
          alert("–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + json.message);
        }
      })
      .catch(err => {
        console.error(err);
        alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞—è–≤–∫—É");
      });
    }
  </script>
</body>
</html>
