<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–Ü—Å—Ç–æ—Ä—ñ—è –∑–∞—è–≤–æ–∫</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* ... existing styles ... */

    /* –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ —Ñ–∞–π–ª–æ–≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ */
    .status-history {
      margin: 16px 0;
      padding: 16px;
      background: rgba(0,0,0,0.5);
      border-radius: 12px;
    }

    .status-timeline {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .status-block {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      position: relative;
    }

    .status-block.active {
      background: rgba(33, 150, 243, 0.2);
      border-left: 4px solid #2196f3;
    }

    .status-icon {
      font-size: 24px;
      min-width: 30px;
      text-align: center;
    }

    .status-content {
      flex: 1;
    }

    .status-name {
      font-weight: bold;
      color: #fff;
      margin-bottom: 4px;
    }

    .status-date {
      font-size: 12px;
      color: #ccc;
      margin-bottom: 4px;
    }

    .status-text {
      color: #e0e0e0;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .diagnostic-file {
      margin-top: 8px;
    }

    .pdf-link {
      display: inline-block;
      padding: 8px 12px;
      background: #2196f3;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 14px;
      transition: background-color 0.2s;
    }

    .pdf-link:hover {
      background: #1976d2;
    }

    /* –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —à–∞–≥–æ–≤ —Å—Ç–∞—Ç—É—Å–æ–≤ */
    .steps {
      margin-top: 16px;
      padding: 16px;
      background: rgba(0,0,0,0.5);
      border-radius: 12px;
    }

    .step-block {
      margin-bottom: 8px;
      padding: 12px;
      border-radius: 8px;
      background: rgba(0,0,0,0.3);
      transition: background-color 0.2s;
    }

    .step-block.completed {
      background: rgba(76, 175, 80, 0.2);
      border-left: 4px solid #4caf50;
    }

    .step-block.active {
      background: rgba(33, 150, 243, 0.2);
      border-left: 4px solid #2196f3;
    }

    .step-block .status-icon {
      margin-right: 12px;
    }

    .step-block .diagnostic-pdf {
      margin-top: 8px;
      padding: 8px;
      background: rgba(33, 150, 243, 0.1);
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <!-- ... existing HTML structure ... -->

  <script>
    // ... existing functions ...

    async function fetchRequestHistory(requestId) {
      try {
        const response = await fetch(`/api/get_request_history/${requestId}`);
        const data = await response.json();
        if (data.status === 'ok') {
          return data.history;
        }
        return [];
      } catch (error) {
        console.error('Error fetching request history:', error);
        return [];
      }
    }

    function createStatusBlock(entry, currentStatus) {
      const statusBlock = document.createElement('div');
      statusBlock.className = 'status-block';
      if (entry.status === currentStatus) {
        statusBlock.classList.add('active');
      }

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É —Å—Ç–∞—Ç—É—Å–∞
      let statusIcon = 'üìù';
      if (entry.status === '–î—ñ–∞–≥–Ω–æ—Å—Ç—É–≤–∞–Ω–Ω—è') statusIcon = 'üîß';
      if (entry.status === '–í–∏—Å–Ω–æ–≤–æ–∫') statusIcon = 'üìã';
      if (entry.status === '–ó–∞–≤–µ—Ä—à–µ–Ω–æ') statusIcon = '‚úÖ';

      statusBlock.innerHTML = `
        <div class="status-icon">${statusIcon}</div>
        <div class="status-content">
          <div class="status-name">${entry.status}</div>
          <div class="status-date">${formatLocal(entry.date)}</div>
          <div class="status-text">${entry.text}</div>
          ${entry.diagnostic_file ? `
            <div class="diagnostic-file">
              <a href="/download/${entry.diagnostic_file}" target="_blank" class="pdf-link">
                üìÑ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫—É
              </a>
            </div>
          ` : ''}
        </div>
      `;

      return statusBlock;
    }

    async function render(list) {
      const out = document.getElementById('history');
      out.innerHTML = "";

      for (const r of list) {
        const card = document.createElement('div');
        card.className = 'request-card';

        // ... existing header creation ...

        const body = document.createElement('div');
        body.className = 'request-body';

        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        body.innerHTML += `
          <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <a href="tel:${r.phone}">${r.phone}</a></p>
          <p><strong>–û–ø–∏—Å –ø—Ä–æ–±–ª–µ–º–∏:</strong> ${r.problem}</p>
        `;

        // –ü–æ–ª—É—á–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å—Ç–∞—Ç—É—Å–æ–≤
        const history = await fetchRequestHistory(r.id);
        if (history.length > 0) {
          const historyContainer = document.createElement('div');
          historyContainer.className = 'status-history';
          historyContainer.innerHTML = '<h3>–Ü—Å—Ç–æ—Ä—ñ—è —Å—Ç–∞—Ç—É—Å—ñ–≤</h3>';

          const timeline = document.createElement('div');
          timeline.className = 'status-timeline';

          history.forEach(entry => {
            timeline.appendChild(createStatusBlock(entry, r.status));
          });

          historyContainer.appendChild(timeline);
          body.appendChild(historyContainer);
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –≤–ª–æ–∂–µ–Ω–∏—è
        if (r.media) {
          const attachments = document.createElement('div');
          attachments.className = 'attachments';
          
          r.media.split(',').forEach(url => {
            url = url.trim();
            if (url) {
              attachments.append(createAttachmentElement(url));
            }
          });
          
          body.append(attachments);
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —à–∞–≥–∏ —Å—Ç–∞—Ç—É—Å–æ–≤
        const statuses = [
          {name: '1. –°—Ç–≤–æ—Ä–µ–Ω–∞', key: '–°—Ç–≤–æ—Ä–µ–Ω–∞', icon: 'üìù'},
          {name: '2. –î—ñ–∞–≥–Ω–æ—Å—Ç—É–≤–∞–Ω–Ω—è', key: '–î—ñ–∞–≥–Ω–æ—Å—Ç—É–≤–∞–Ω–Ω—è', icon: 'üîß'},
          {name: '3. –í–∏—Å–Ω–æ–≤–æ–∫', key: '–í–∏—Å–Ω–æ–≤–æ–∫', icon: 'üìã'},
          {name: '4. –ó–∞–≤–µ—Ä—à–µ–Ω–æ', key: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ', icon: '‚úÖ'}
        ];

        const steps = document.createElement('div');
        steps.className = 'steps';

        statuses.forEach((s, index) => {
          const stepBlock = document.createElement('div');
          stepBlock.className = 'step-block';
          
          if (index === 0 || r.status === s.key) {
            stepBlock.classList.add(r.status === s.key ? 'active' : 'completed');
          }

          const stepContent = document.createElement('div');
          stepContent.className = 'step-content';
          stepContent.innerHTML = `
            <div class="left">
              <span class="status-icon">${s.icon}</span>
              <span class="name">${s.name}</span>
              ${index === 0 || r.status === s.key ? 
                `<span class="time">${formatLocal(r.date)}</span>` : ''}
            </div>
          `;

          if (s.key === '–î—ñ–∞–≥–Ω–æ—Å—Ç—É–≤–∞–Ω–Ω—è' && r.status === '–î—ñ–∞–≥–Ω–æ—Å—Ç—É–≤–∞–Ω–Ω—è' && r.diagnostic_file) {
            const pdfLink = document.createElement('div');
            pdfLink.className = 'diagnostic-pdf';
            pdfLink.innerHTML = `
              <a href="/download/${r.diagnostic_file}" target="_blank" class="pdf-link">
                üìÑ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫—É
              </a>
            `;
            stepContent.appendChild(pdfLink);
          }

          stepBlock.appendChild(stepContent);
          steps.appendChild(stepBlock);
        });

        body.appendChild(steps);
        card.appendChild(body);

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è/—Å–∫—Ä—ã—Ç–∏—è –¥–µ—Ç–∞–ª–µ–π
        card.querySelector('.request-header').addEventListener('click', () => {
          body.style.display = body.style.display === 'block' ? 'none' : 'block';
        });

        out.appendChild(card);
      }
    }

    // ... rest of existing code ...
  </script>
</body>
</html>
