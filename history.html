<!DOCTYPE html>
<html lang="uk">
<head>
  <!-- ‚Ä¶ –≤–∞—à <head> ‚Ä¶ -->
  <style>
    /* ‚Ä¶ –≤–∞—à–µ CSS ‚Ä¶ */
    .delete-btn {
      background: #a00;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      float: right;
      font-size: 14px;
    }
    .delete-btn:hover {
      background: #c00;
    }
  </style>
</head>
<body>
  <div class="history-container" id="history"></div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
  const tg = window.Telegram.WebApp;
  tg.ready(); tg.expand();

  async function submitForm() {
    const vinCar = document.getElementById('vin-input-car').value.trim();
    const vinEcu = document.getElementById('vin-input-ecu').value.trim();
    const problem = document.getElementById('problem').value.trim();
    const phone = document.getElementById('phone-input').value.trim();
    const chat_id = String(tg.initDataUnsafe.user.id);
    const owner_name = tg.initDataUnsafe.user.first_name || "–≥–æ—Å—Ç—å";

    if (vinCar.length !== 17) return alert('VIN –∞–≤—Ç–æ–º–æ–±—ñ–ª—è –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ 17 —Å–∏–º–≤–æ–ª—ñ–≤');
    if (vinEcu.length !== 17) return alert('VIN –∫–æ–º–ø‚Äô—é—Ç–µ—Ä–∞ –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ 17 —Å–∏–º–≤–æ–ª—ñ–≤');
    if (!problem) return alert('–û–ø–∏—à—ñ—Ç—å –ø—Ä–æ–±–ª–µ–º—É');

    // --- –∑–¥–µ—Å—å –ø–æ–ø—Ä–∞–≤–∫–∞ –Ω–∞ –≤–∞—à —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å ---
    const now = new Date();
    const offsetMs = now.getTimezoneOffset() * 60000;
    const clientDate = new Date(now.getTime() - offsetMs).toISOString();
    // ------------------------

    const payload = {
      vin:         vinEcu,
      car_vin:     vinCar,
      problem:     problem,
      phone:       phone,
      owner:       "telegram",
      owner_name:  owner_name,
      chat_id:     chat_id,
      date:        clientDate
    };

    console.log("üì§ Payload:", payload);

    try {
      const res = await fetch("https://crm.dolce.kyiv.ua/api/create_request", {
        method:  "POST",
        headers: { "Content-Type": "application/json" },
        body:    JSON.stringify(payload)
      });
      const result = await res.json();
      console.log("‚úÖ Server response:", result);

      if (result.status === "ok") {
        alert("–ó–∞—è–≤–∫–∞ —É—Å–ø—ñ—à–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–∞!");
        window.location.href = 'history.html';
      } else {
        alert("–ü–æ–º–∏–ª–∫–∞: " + result.message);
      }
    } catch (err) {
      alert("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: " + err.message);
    }
  }
</script>

  </script>
</body>
</html>
