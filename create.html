<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: url('tesla-bg.png') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      min-height: 100vh;
    }
    .container { padding: 20px; max-width: 600px; margin: auto; }
    .page-header { font-size: 32px; text-align: center; margin-bottom: 24px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .back-btn { display: inline-flex; align-items: center; margin-bottom: 20px; padding: 10px 20px; background: rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: #fff; font-size: 16px; cursor: pointer; transition: all 0.3s ease; }
    .form-card { background: rgba(0, 0, 0, 0.85); border-radius: 16px; padding: 24px; box-shadow: 0 4px 24px rgba(0,0,0,0.2); backdrop-filter: blur(10px); }
    .form-row { margin-bottom: 20px; position: relative; }
    .form-row label { display: block; margin-bottom: 8px; color: #e0e0e0; font-size: 15px; font-weight: 500; }
    .input-wrapper { position: relative; display: flex; align-items: center; gap: 10px; }
    .form-row input, .form-row textarea { flex: 1; padding: 12px 16px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 16px; }
    .scan-btn { width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; background: rgba(3,199,90,0.1); border: 1px solid rgba(3,199,90,0.3); border-radius: 10px; font-size: 20px; color: #03c75a; cursor: pointer; transition: all 0.2s ease; }
    .scan-btn:hover { background: rgba(3,199,90,0.2); transform: scale(1.05); }
    .submit-btn { display: block; width: 100%; padding: 14px; margin-top: 24px; background: #03c75a; border: none; border-radius: 10px; color: #fff; font-size: 18px; font-weight: bold; cursor: pointer; }
    .form-row.file-row { overflow: hidden; display: flex; flex-direction: column; }
    #file-preview { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px; max-width: 100%; box-sizing: border-box; }
    #file-preview > div { position: relative; max-width: 100px; max-height: 100px; overflow: hidden; border-radius: 8px; background: rgba(255,255,255,0.08); box-shadow: 0 2px 8px rgba(0,0,0,0.07); display: flex; align-items: center; justify-content: center; }
    #file-preview img, #file-preview video { max-width: 90px; max-height: 90px; border-radius: 6px; display: block; }
    #file-preview span { position: absolute; top: -8px; right: -8px; cursor: pointer; background: #e53935; color: white; border-radius: 50%; padding: 0 6px; font-size: 18px; z-index: 2; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
    
    /* –ü—Ä–æ—Å—Ç–æ–π VIN Scanner */
    .vin-scanner-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.95);
      align-items: center;
      justify-content: center;
      flex-direction: column;
      overflow-y: auto;
      padding: 20px 0;
    }
    .vin-scanner-content {
      background: #222;
      padding: 16px 12px;
      border-radius: 16px;
      max-width: 340px;
      width: 95%;
      text-align: center;
      max-height: 90vh;
      overflow-y: auto;
    }
    .vin-scanner-video {
      width: 100%;
      max-width: 280px;
      border: 3px solid #03c75a;
      border-radius: 8px;
      margin-bottom: 20px;
      height: 60px;
      object-fit: cover;
    }
    .vin-input-large {
      font-size: 18px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 2px solid #03c75a;
      width: 100%;
      text-align: center;
      letter-spacing: 1px;
      background: #333;
      color: #fff;
      margin-bottom: 12px;
      font-weight: bold;
    }
    .vin-status {
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-weight: bold;
    }
    .vin-status.valid {
      background: rgba(3,199,90,0.2);
      color: #03c75a;
    }
    .vin-status.invalid {
      background: rgba(229,57,53,0.2);
      color: #e53935;
    }
    .vin-status.partial {
      background: rgba(255,193,7,0.2);
      color: #ffc107;
    }
    .scanner-buttons {
      display: flex;
      gap: 8px;
      width: 100%;
      flex-wrap: wrap;
      justify-content: center;
    }
    .scanner-btn {
      flex: 1;
      min-width: 80px;
      padding: 10px 8px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      white-space: nowrap;
    }
    .scanner-btn.confirm {
      background: #03c75a;
      color: #000;
    }
    .scanner-btn.cancel {
      background: #e53935;
      color: #fff;
    }
    .scanner-btn.manual {
      background: #ffc107;
      color: #000;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É</div>
    <div class="back-btn" onclick="window.location.href='index.html'">‚Üê –ù–∞–∑–∞–¥</div>
    <div class="form-card">
      <div class="form-row">
        <label for="vin-car">VIN –∞–≤—Ç–æ–º–æ–±—ñ–ª—è</label>
        <div class="input-wrapper">
          <input type="text" id="vin-car" maxlength="17" placeholder="–í–≤–µ–¥—ñ—Ç—å VIN –∞–≤—Ç–æ" required />
          <div class="scan-btn" onclick="openVinScanner('vin-car')" title="–°–∫–∞–Ω—É–≤–∞—Ç–∏ VIN">üîç</div>
        </div>
        <div id="vin-car-status" class="vin-status" style="display:none;"></div>
      </div>
      <div class="form-row">
        <label for="vin-mceu">VIN –∑ –º–æ–Ω—ñ—Ç–æ—Ä—É –∞–≤—Ç–æ</label>
        <div class="input-wrapper">
          <input type="text" id="vin-mceu" maxlength="17" placeholder="–í–≤–µ–¥—ñ—Ç—å VIN –∑ –º–æ–Ω—ñ—Ç–æ—Ä—É –∞–≤—Ç–æ" required />
          <div class="scan-btn" onclick="openVinScanner('vin-mceu')" title="–°–∫–∞–Ω—É–≤–∞—Ç–∏ VIN">üîç</div>
        </div>
        <div id="vin-mceu-status" class="vin-status" style="display:none;"></div>
      </div>
      <div class="form-row">
        <label for="problem">–û–ø–∏—Å –ø—Ä–æ–±–ª–µ–º–∏</label>
        <textarea id="problem" placeholder="–û–ø–∏—à—ñ—Ç—å –ø—Ä–æ–±–ª–µ–º—É" rows="4" required></textarea>
      </div>
      <div class="form-row">
        <label for="phone">–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É</label>
        <input type="tel" id="phone" placeholder="+380 XX XXX XX XX" required value="+380" maxlength="13" />
      </div>
      <div class="form-row file-row">
        <label for="file-input">–§–æ—Ç–æ / –≤—ñ–¥–µ–æ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
        <input type="file" id="file-input" name="media" accept="image/*,video/*" multiple style="color: white;" onchange="previewFiles()" />
        <div id="file-preview"></div>
      </div>
      <button id="submit-btn" class="submit-btn" onclick="submitForm()">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞—è–≤–∫—É</button>
    </div>
  </div>
  
  <!-- –ü—Ä–æ—Å—Ç–æ–π VIN Scanner Modal -->
  <div id="vin-scanner-modal" class="vin-scanner-modal">
    <div class="vin-scanner-content">
      <h3 style="margin:0 0 16px 0;color:#03c75a;">–°–∫–∞–Ω—É–≤–∞–Ω–Ω—è VIN</h3>
      <p style="margin:0 0 20px 0;font-size:14px;color:#ccc;">–ù–∞ –º–æ–Ω—ñ—Ç–æ—Ä—ñ Tesla –ø—Ä–æ–∫—Ä—É—Ç—ñ—Ç—å –µ–∫—Ä–∞–Ω –≤–Ω–∏–∑, —â–æ–± –∑–Ω–∞–π—Ç–∏ VIN-–∫–æ–¥ (17 —Å–∏–º–≤–æ–ª—ñ–≤, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥: 5YJ3E1EB7NF342309). –ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ VIN —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ö–æ–ø—ñ—é–≤–∞—Ç–∏ VIN" –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å –≤—Ä—É—á–Ω—É</p>
      
      <div style="position: relative; margin-bottom: 20px;">
        <video id="vin-scanner-video" class="vin-scanner-video" autoplay playsinline></video>
        <!-- –í–∏–∑—É–∞–ª—å–Ω—ã–π –º–∞–∫–µ—Ç –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;">
          <!-- –†–∞–º–∫–∞ –¥–ª—è VIN -->
          <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; height: 60%; border: 2px dashed #03c75a; border-radius: 4px; background: rgba(3,199,90,0.1);">
            <!-- –£–≥–ª–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã -->
            <div style="position: absolute; top: -2px; left: -2px; width: 8px; height: 8px; background: #03c75a; border-radius: 50%;"></div>
            <div style="position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: #03c75a; border-radius: 50%;"></div>
            <div style="position: absolute; bottom: -2px; left: -2px; width: 8px; height: 8px; background: #03c75a; border-radius: 50%;"></div>
            <div style="position: absolute; bottom: -2px; right: -2px; width: 8px; height: 8px; background: #03c75a; border-radius: 50%;"></div>
            <!-- –ü—Ä–∏–º–µ—Ä VIN –≤–Ω—É—Ç—Ä–∏ —Ä–∞–º–∫–∏ -->
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #03c75a; font-size: 10px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.8); letter-spacing: 1px;">
              5YJ3E1EB7NF342309
            </div>
          </div>
          <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ -->
          <div style="position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); color: #03c75a; font-size: 10px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.8);">
            –ù–∞–≤–µ–¥—ñ—Ç—å —Ä–∞–º–∫—É –Ω–∞ VIN
          </div>
        </div>
      </div>
      
      <input type="text" id="vin-scanner-input" class="vin-input-large" maxlength="17" placeholder="–í–≤–µ–¥—ñ—Ç—å VIN –≤—Ä—É—á–Ω—É" />
      
      <div id="vin-scanner-status" class="vin-status" style="display:none;"></div>
      
      <div class="scanner-buttons">
        <div style="display: flex; gap: 8px; width: 100%; margin-bottom: 8px;">
          <button id="vin-scanner-confirm" class="scanner-btn confirm" style="flex: 1;">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
          <button id="vin-scanner-copy" class="scanner-btn manual" style="flex: 1;">–ö–æ–ø—ñ—é–≤–∞—Ç–∏ VIN</button>
        </div>
        <div style="display: flex; gap: 8px; width: 100%;">
          <button id="vin-scanner-manual" class="scanner-btn manual" style="flex: 1;">–í—Ä—É—á–Ω—É</button>
          <button id="vin-scanner-cancel" class="scanner-btn cancel" style="flex: 1;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    
    let currentVinField = null;
    let videoStream = null;
    
    // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è VIN
    function validateVin(vin) {
      if (!vin || vin.length !== 17) return 'invalid';
      if (!/^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) return 'invalid';
      return 'valid';
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ VIN
    function updateVinStatus(vin) {
      const statusElement = document.getElementById('vin-scanner-status');
      const validation = validateVin(vin);
      
      statusElement.style.display = 'block';
      statusElement.className = 'vin-status ' + validation;
      
      if (validation === 'valid') {
        statusElement.textContent = '‚úÖ VIN –≤–∞–ª—ñ–¥–Ω–∏–π';
      } else if (vin.length > 0 && vin.length < 17) {
        statusElement.textContent = '‚ö†Ô∏è –ù–µ–ø–æ–≤–Ω–∏–π VIN (' + vin.length + '/17)';
        statusElement.className = 'vin-status partial';
      } else {
        statusElement.textContent = '‚ùå –ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π VIN';
      }
    }
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ VIN —Å–∫–∞–Ω–µ—Ä–∞
    function openVinScanner(fieldId) {
      currentVinField = fieldId;
      document.getElementById('vin-scanner-modal').style.display = 'flex';
      document.getElementById('vin-scanner-input').value = '';
      document.getElementById('vin-scanner-status').style.display = 'none';
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
      navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: 'environment',
          width: { ideal: 1280 },
          height: { ideal: 720 }
        } 
      }).then((stream) => {
        videoStream = stream;
        const video = document.getElementById('vin-scanner-video');
        video.srcObject = stream;
        video.play();
      }).catch(err => {
        console.log('–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—á–Ω–æ–π –≤–≤–æ–¥');
        document.getElementById('vin-scanner-video').style.display = 'none';
      });
      
      // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
      setTimeout(() => {
        document.getElementById('vin-scanner-input').focus();
      }, 500);
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ VIN —Å–∫–∞–Ω–µ—Ä–∞
    function closeVinScanner() {
      document.getElementById('vin-scanner-modal').style.display = 'none';
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      currentVinField = null;
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('vin-scanner-input').addEventListener('input', function() {
      // –û—á–∏—â–∞–µ–º –æ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
      this.value = this.value.replace(/[^A-Z0-9]/gi, '').replace(/[IOQ]/g, '').toUpperCase().slice(0, 17);
      updateVinStatus(this.value);
    });
    
    document.getElementById('vin-scanner-confirm').onclick = function() {
      const vin = document.getElementById('vin-scanner-input').value.trim();
      if (vin.length > 0 && currentVinField) {
        const vinInput = document.getElementById(currentVinField);
        vinInput.value = vin;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–æ–ª–µ
        const statusElement = document.getElementById(currentVinField + '-status');
        statusElement.style.display = 'block';
        statusElement.className = 'vin-status ' + validateVin(vin);
        
        if (validateVin(vin) === 'valid') {
          statusElement.textContent = '‚úÖ VIN –≤–∞–ª—ñ–¥–Ω–∏–π';
          vinInput.style.background = '#d4ffd4';
          setTimeout(() => { vinInput.style.background = ''; }, 2000);
        } else if (vin.length < 17) {
          statusElement.textContent = '‚ö†Ô∏è –ù–µ–ø–æ–≤–Ω–∏–π VIN (' + vin.length + '/17)';
          statusElement.className = 'vin-status partial';
        } else {
          statusElement.textContent = '‚ùå –ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π VIN';
        }
        
        closeVinScanner();
        vinInput.focus();
      }
    };
    
    document.getElementById('vin-scanner-copy').onclick = async function() {
      const video = document.getElementById('vin-scanner-video');
      if (video.srcObject && video.readyState === 4) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        const copyBtn = this;
        const originalText = copyBtn.textContent;
        copyBtn.textContent = '–°–∫–∞–Ω—É–≤–∞–Ω–Ω—è...';
        copyBtn.disabled = true;
        
        try {
          // –î–µ–ª–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫ –∑–∞—Ö–≤–∞—Ç–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
          let bestResult = null;
          let attempts = 0;
          const maxAttempts = 3;
          
          while (attempts < maxAttempts && !bestResult) {
            attempts++;
            
            // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∫–∞–¥—Ä–∞
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // –£–ª—É—á—à–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ OCR –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
            const { data: { text } } = await Tesseract.recognize(canvas.toDataURL(), 'eng', {
              tessedit_char_whitelist: 'ABCDEFGHJKLMNPRSTUVWXYZ0123456789',
              tessedit_pageseg_mode: '6', // Uniform block of text
              tessedit_ocr_engine_mode: '3', // Default, based on what is available
              preserve_interword_spaces: '1'
            });
            
            console.log(`–ü–æ–ø—ã—Ç–∫–∞ ${attempts}, —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:`, text);
            
            // –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ VIN —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏
            let foundVin = null;
            
            // 1. –ò—â–µ–º —Ç–æ—á–Ω—ã–µ Tesla VIN (–Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 5YJ, 7SA, 7SAY –∏ —Ç.–¥.)
            const teslaVinPattern = /(5YJ|7SA|7SAY|5YJY|5YJS|5YJ3|5YJY|5YJSA|5YJSE|5YJSB|5YJSC|5YJSD|5YJSE|5YJSF|5YJSG|5YJSH|5YJSI|5YJSJ|5YJSK|5YJSL|5YJSM|5YJSN|5YJSO|5YJSP|5YJSQ|5YJSR|5YJSS|5YJST|5YJSU|5YJSV|5YJSW|5YJSX|5YJSY|5YJSZ)[A-HJ-NPR-Z0-9]{14}/gi;
            const teslaMatches = text.match(teslaVinPattern);
            if (teslaMatches && teslaMatches.length > 0) {
              foundVin = teslaMatches[0].toUpperCase();
              console.log('–ù–∞–π–¥–µ–Ω Tesla VIN:', foundVin);
            }
            
            // 2. –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ Tesla VIN, –∏—â–µ–º –ª—é–±–æ–π 17-—Å–∏–º–≤–æ–ª—å–Ω—ã–π VIN —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
            if (!foundVin) {
              const allVinMatches = text.match(/[A-HJ-NPR-Z0-9]{17}/gi) || [];
              if (allVinMatches.length > 0) {
                // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è - –∏—Å–∫–ª—é—á–∞–µ–º –æ—á–µ–≤–∏–¥–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ VIN
                const validVins = allVinMatches.filter(vin => {
                  const upperVin = vin.toUpperCase();
                  
                  // –ò—Å–∫–ª—é—á–∞–µ–º VIN, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏–ª–∏ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
                  if (/^[A-Z]+$/.test(upperVin) || /^[0-9]+$/.test(upperVin)) {
                    return false;
                  }
                  
                  // –ò—Å–∫–ª—é—á–∞–µ–º VIN, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–≥–ª—è–¥—è—Ç –∫–∞–∫ —Å–ª—É—á–∞–π–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
                  const invalidPatterns = ['MOTOR', 'ENGINE', 'COMPUTER', 'MODEL', 'TESLA', 'AUTO', 'CAR'];
                  if (invalidPatterns.some(pattern => upperVin.includes(pattern))) {
                    return false;
                  }
                  
                  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ VIN —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞–∑—É–º–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—É–∫–≤ –∏ —Ü–∏—Ñ—Ä
                  const letters = (upperVin.match(/[A-Z]/g) || []).length;
                  const digits = (upperVin.match(/[0-9]/g) || []).length;
                  
                  // VIN –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏ –±—É–∫–≤—ã, –∏ —Ü–∏—Ñ—Ä—ã, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –±—É–∫–≤ –ø–æ–¥—Ä—è–¥
                  if (letters < 3 || digits < 3) {
                    return false;
                  }
                  
                  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã (–ø—Ä–∏–∑–Ω–∞–∫ –æ—à–∏–±–∫–∏ OCR)
                  const uniqueChars = new Set(upperVin).size;
                  if (uniqueChars < 8) {
                    return false;
                  }
                  
                  return true;
                });
                
                if (validVins.length > 0) {
                  foundVin = validVins[0].toUpperCase();
                  console.log('–ù–∞–π–¥–µ–Ω –æ–±—â–∏–π VIN:', foundVin);
                }
              }
            }
            
            // 3. –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞—à–ª–∏, –∏—â–µ–º –≤ –æ—á–∏—â–µ–Ω–Ω–æ–º —Ç–µ–∫—Å—Ç–µ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
            if (!foundVin) {
              // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
              const cleanedText = text
                .replace(/[^A-Z0-9]/gi, '')
                .toUpperCase()
                .replace(/[IOQ]/g, ''); // –£–±–∏—Ä–∞–µ–º –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã
              
              for (let i = 0; i <= cleanedText.length - 17; i++) {
                const candidate = cleanedText.slice(i, i + 17);
                
                // –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
                if (/[A-Z]/.test(candidate) && /[0-9]/.test(candidate) && 
                    !candidate.includes('MOTOR') && !candidate.includes('ENGINE') && 
                    !candidate.includes('COMPUTER') && !candidate.includes('MODEL') &&
                    !candidate.includes('TESLA') && !candidate.includes('AUTO') &&
                    new Set(candidate).size >= 8) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Å–∏–º–≤–æ–ª–æ–≤
                  
                  foundVin = candidate;
                  console.log('–ù–∞–π–¥–µ–Ω –∫–∞–Ω–¥–∏–¥–∞—Ç VIN:', foundVin);
                  break;
                }
              }
            }
            
            // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ VIN, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if (foundVin) {
              bestResult = foundVin;
              break;
            }
            
            // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
            if (attempts < maxAttempts) {
              await new Promise(resolve => setTimeout(resolve, 500));
            }
          }
          
          if (bestResult) {
            document.getElementById('vin-scanner-input').value = bestResult;
            updateVinStatus(bestResult);
            
            tg.showPopup({
              title: "–£—Å–ø—ñ—Ö",
              message: `VIN –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ ${attempts} —Å–ø—Ä–æ–±—É: ${bestResult}`,
              buttons: [{ type: "ok" }]
            });
          } else {
            tg.showPopup({
              title: "–ü–æ–º–∏–ª–∫–∞",
              message: "VIN –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø—ñ—Å–ª—è –∫—ñ–ª—å–∫–æ—Ö —Å–ø—Ä–æ–±. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ VIN –≤–∏–¥–Ω–æ –Ω–∞ –º–æ–Ω—ñ—Ç–æ—Ä—ñ —Ç–∞ —Å–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.",
              buttons: [{ type: "ok" }]
            });
          }
          
        } catch (error) {
          console.error('–ü–æ–º–∏–ª–∫–∞ OCR:', error);
          tg.showPopup({
            title: "–ü–æ–º–∏–ª–∫–∞",
            message: "–ù–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ VIN. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å –≤—Ä—É—á–Ω—É.",
            buttons: [{ type: "ok" }]
          });
        } finally {
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
          copyBtn.textContent = originalText;
          copyBtn.disabled = false;
        }
      } else {
        tg.showPopup({
          title: "–ü–æ–º–∏–ª–∫–∞",
          message: "–ö–∞–º–µ—Ä–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞. –ó–∞—á–µ–∫–∞–π—Ç–µ –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å VIN –≤—Ä—É—á–Ω—É.",
          buttons: [{ type: "ok" }]
        });
      }
    };
    
    document.getElementById('vin-scanner-manual').onclick = function() {
      // –°–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –∏ —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ —Ä—É—á–Ω–æ–º –≤–≤–æ–¥–µ
      document.getElementById('vin-scanner-video').style.display = 'none';
      document.getElementById('vin-scanner-input').focus();
    };
    
    document.getElementById('vin-scanner-cancel').onclick = closeVinScanner;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–ª—è—Ö
    ['vin-car', 'vin-mceu'].forEach(function(field) {
      const input = document.getElementById(field);
      input.addEventListener('input', function() {
        this.value = this.value.replace(/[^A-Z0-9]/gi, '').replace(/[IOQ]/g, '').toUpperCase().slice(0, 17);
        
        const statusElement = document.getElementById(field + '-status');
        const validation = validateVin(this.value);
        
        statusElement.style.display = 'block';
        statusElement.className = 'vin-status ' + validation;
        
        if (validation === 'valid') {
          statusElement.textContent = '‚úÖ VIN –≤–∞–ª—ñ–¥–Ω–∏–π';
        } else if (this.value.length > 0 && this.value.length < 17) {
          statusElement.textContent = '‚ö†Ô∏è –ù–µ–ø–æ–≤–Ω–∏–π VIN (' + this.value.length + '/17)';
          statusElement.className = 'vin-status partial';
        } else {
          statusElement.textContent = '‚ùå –ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π VIN';
        }
      });
    });
    
    // –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ç–µ–ª–µ—Ñ–æ–Ω—É
    function validatePhone(phone) {
      return /^\+380\d{9}$/.test(phone);
    }
    
    const phoneInput = document.getElementById("phone");
    phoneInput.addEventListener("input", function(e) {
      if (!this.value.startsWith("+380")) {
        this.value = "+380" + this.value.replace(/[^\d]/g, "").replace(/^380/, "");
      }
      if (this.value.length > 13) {
        this.value = this.value.slice(0, 13);
      }
    });
    
    // –ü—Ä–µ–≤'—é —Ñ–∞–π–ª—ñ–≤
    function previewFiles() {
      const input = document.getElementById("file-input");
      const preview = document.getElementById("file-preview");
      preview.innerHTML = "";
      Array.from(input.files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function (e) {
          const container = document.createElement("div");
          container.style.position = "relative";
          container.style.maxWidth = "100px";
          container.style.maxHeight = "100px";
          const closeBtn = document.createElement("span");
          closeBtn.innerHTML = "√ó";
          closeBtn.onclick = () => removePreview(index);
          const element = document.createElement(file.type.startsWith('video') ? "video" : "img");
          element.src = e.target.result;
          element.style.maxWidth = "90px";
          element.style.maxHeight = "90px";
          if (file.type.startsWith('video')) { element.controls = true; }
          container.appendChild(element);
          container.appendChild(closeBtn);
          preview.appendChild(container);
        };
        reader.readAsDataURL(file);
      });
    }
    
    function removePreview(index) {
      const input = document.getElementById("file-input");
      const dt = new DataTransfer();
      const { files } = input;
      Array.from(files).forEach((file, i) => {
        if (i !== index) dt.items.add(file);
      });
      input.files = dt.files;
      previewFiles();
    }
    
    // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º–∏
    async function submitForm() {
      const vinCar = document.getElementById("vin-car").value.trim();
      const vinMceu = document.getElementById("vin-mceu").value.trim();
      const problem = document.getElementById("problem").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const chat_id = tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id ? String(tg.initDataUnsafe.user.id) : "unknown";
      const owner_name = tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.first_name ? tg.initDataUnsafe.user.first_name : "";
      
      if (!vinCar || !vinMceu || !problem || !phone) {
        tg.showPopup({
          title: "–ü–æ–º–∏–ª–∫–∞",
          message: "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è".slice(0, 64),
          buttons: [{ type: "ok" }]
        });
        return;
      }
      
      if (!validatePhone(phone)) {
        tg.showPopup({
          title: "–ü–æ–º–∏–ª–∫–∞",
          message: "–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É".slice(0, 64),
          buttons: [{ type: "ok" }]
        });
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å VIN
      if (validateVin(vinCar) !== 'valid') {
        tg.showPopup({
          title: "–ü–æ–º–∏–ª–∫–∞",
          message: "–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π VIN –∞–≤—Ç–æ–º–æ–±—ñ–ª—è".slice(0, 64),
          buttons: [{ type: "ok" }]
        });
        return;
      }
      
      if (validateVin(vinMceu) !== 'valid') {
        tg.showPopup({
          title: "–ü–æ–º–∏–ª–∫–∞",
          message: "–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π VIN –∑ –º–æ–Ω—ñ—Ç–æ—Ä—É –∞–≤—Ç–æ".slice(0, 64),
          buttons: [{ type: "ok" }]
        });
        return;
      }
      
      const botData = {
        vin: vinMceu,
        car_vin: vinCar,
        problem: problem,
        phone: phone,
        owner: "telegram",
        owner_name: owner_name,
        chat_id: chat_id
      };
      
      tg.sendData(JSON.stringify(botData));
      
      const form = new FormData();
      form.append("vin", vinMceu);
      form.append("car_vin", vinCar);
      form.append("problem", problem);
      form.append("phone", phone);
      form.append("owner", "telegram");
      form.append("owner_name", owner_name);
      form.append("chat_id", chat_id);
      
      const input = document.getElementById("file-input");
      for (let i = 0; i < input.files.length; i++) {
        form.append("media", input.files[i]);
      }
      
      fetch("https://tesla-service-dashboard-new-549c7415b70b.herokuapp.com/proxy_create_request", {
        method: "POST",
        body: form
      })
        .then(async res => {
          let text = await res.text();
          let data;
          try {
            data = JSON.parse(text);
          } catch {
            data = text;
          }
          if (res.ok) {
            tg.showPopup({
              title: "–£—Å–ø—ñ—Ö",
              message: String(typeof data === 'string' ? data : (data.message || "–ó–∞—è–≤–∫—É –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ!")).slice(0, 250),
              buttons: [{ type: "ok" }]
            });
            setTimeout(() => window.location.href = "history.html", 1500);
          } else {
            tg.showPopup({
              title: "–ü–æ–º–∏–ª–∫–∞ CRM",
              message: String(typeof data === 'string' ? data : (data.message || text)).slice(0, 250),
              buttons: [{ type: "ok" }]
            });
          }
        })
        .catch(error => {
          tg.showPopup({
            title: "–ü–æ–º–∏–ª–∫–∞",
            message: String(error && error.toString ? error.toString() : "–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞").slice(0, 250),
            buttons: [{ type: "ok" }]
          });
        });
    }
  </script>
</body>
</html>
