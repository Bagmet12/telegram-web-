<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Створити заявку</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: #fff;
      background: url('tesla-bg.png') no-repeat center center fixed;
      background-size: cover;
    }
    .container { padding: 16px; }
    .page-header { font-size: 32px; text-align: center; margin-bottom: 16px;}
    .form-card {
      background: rgba(0,0,0,0.7);
      border-radius: 12px;
      padding: 20px;
    }
    .form-row { margin-bottom: 12px; }
    .form-row label { display: block; margin-bottom: 4px; color: #ccc; }
    .form-row input, .form-row textarea {
      width: 100%; padding: 8px; border-radius: 6px;
      border: 1px solid #444; background: #121212; color: #fff;
    }
    .submit-btn {
      width: 100%; padding: 12px; border: none;
      background: #03c75a; color: #000; font-size: 16px;
      border-radius: 8px; cursor: pointer;
    }
    .submit-btn:disabled { background: #555; cursor: default; }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">Створити заявку</div>
    <div class="form-card">
      <div class="form-row">
        <label for="vin-input-car">VIN автомобіля (17)</label>
        <input id="vin-input-car" type="text" maxlength="17" />
      </div>
      <div class="form-row">
        <label for="vin-input-ecu">VIN комп’ютера (17)</label>
        <input id="vin-input-ecu" type="text" maxlength="17" />
      </div>
      <div class="form-row">
        <label for="problem">Опис проблеми</label>
        <textarea id="problem" rows="4"></textarea>
      </div>
      <div class="form-row">
        <label for="phone-input">Номер телефону</label>
        <input id="phone-input" type="tel" />
      </div>
      <div class="form-row">
        <label for="file-input">Фото/відео (необов’язково)</label>
        <input id="file-input" type="file" accept="image/*,video/*" />
      </div>
      <button
        id="submit-btn"
        class="submit-btn"
        onclick="submitForm()"
        disabled
      >Надіслати</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    // полeзунок валидации
    const btn = document.getElementById("submit-btn");
    const fields = [
      document.getElementById("vin-input-car"),
      document.getElementById("vin-input-ecu"),
      document.getElementById("problem"),
      document.getElementById("phone-input")
    ];
    fields.forEach(f => f.addEventListener("input", validateForm));
    function validateForm(){
      const ok = fields.every(f => f.value.trim().length>0)
               && fields[0].value.trim().length===17
               && fields[1].value.trim().length===17;
      btn.disabled = !ok;
    }

    async function submitForm(){
      // собираем данные
      const vinCar = fields[0].value.trim();
      const vinEcu = fields[1].value.trim();
      const problem = fields[2].value.trim();
      const phone   = fields[3].value.trim();
      const chat_id   = String(tg.initDataUnsafe.user.id);
      const owner_name= tg.initDataUnsafe.user.first_name || "";

      // собираем multipart
      const form = new FormData();
      form.append("vin", vinEcu);
      form.append("car_vin", vinCar);
      form.append("problem", problem);
      form.append("phone", phone);
      form.append("owner", "telegram");
      form.append("owner_name", owner_name);
      form.append("chat_id", chat_id);

      const fileEl = document.getElementById("file-input");
      if(fileEl.files.length){
        form.append("media", fileEl.files[0]);
      }

      // POST без ручной установки Content-Type
      const res = await fetch("https://crm.dolce.kyiv.ua/api/create_request", {
        method: "POST",
        body: form
      });
      const result = await res.json();

      if(result.status==="ok"){
        alert("Заявка успішно надіслана!");
        location.href = "history.html";
      } else {
        alert("Помилка: "+result.message);
      }
    }
  </script>
</body>
</html>
