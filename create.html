<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: url('tesla-bg.png') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      min-height: 100vh;
    }
    .container { padding: 20px; max-width: 600px; margin: auto; }
    .page-header { font-size: 32px; text-align: center; margin-bottom: 24px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .back-btn { display: inline-flex; align-items: center; margin-bottom: 20px; padding: 10px 20px; background: rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: #fff; font-size: 16px; cursor: pointer; transition: all 0.3s ease; }
    .form-card { background: rgba(0, 0, 0, 0.85); border-radius: 16px; padding: 24px; box-shadow: 0 4px 24px rgba(0,0,0,0.2); backdrop-filter: blur(10px); }
    .form-row { margin-bottom: 20px; position: relative; }
    .form-row label { display: block; margin-bottom: 8px; color: #e0e0e0; font-size: 15px; font-weight: 500; }
    .input-wrapper { position: relative; display: flex; align-items: center; gap: 10px; }
    .form-row input, .form-row textarea { flex: 1; padding: 12px 16px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 16px; }
    .scan-btn { width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; background: rgba(3,199,90,0.1); border: 1px solid rgba(3,199,90,0.3); border-radius: 10px; font-size: 20px; color: #03c75a; cursor: pointer; transition: all 0.2s ease; }
    .scan-btn:hover { background: rgba(3,199,90,0.2); transform: scale(1.05); }
    .submit-btn { display: block; width: 100%; padding: 14px; margin-top: 24px; background: #03c75a; border: none; border-radius: 10px; color: #fff; font-size: 18px; font-weight: bold; cursor: pointer; }
    .form-row.file-row { overflow: hidden; display: flex; flex-direction: column; }
    #file-preview { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px; max-width: 100%; box-sizing: border-box; }
    #file-preview > div { position: relative; max-width: 100px; max-height: 100px; overflow: hidden; border-radius: 8px; background: rgba(255,255,255,0.08); box-shadow: 0 2px 8px rgba(0,0,0,0.07); display: flex; align-items: center; justify-content: center; }
    #file-preview img, #file-preview video { max-width: 90px; max-height: 90px; border-radius: 6px; display: block; }
    #file-preview span { position: absolute; top: -8px; right: -8px; cursor: pointer; background: #e53935; color: white; border-radius: 50%; padding: 0 6px; font-size: 18px; z-index: 2; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
    
    /* VIN Scanner Improvements */
    .vin-candidate-btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: 2px solid #03c75a;
      background: rgba(3,199,90,0.1);
      color: #03c75a;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin: 4px;
      transition: all 0.2s ease;
      letter-spacing: 1px;
    }
    .vin-candidate-btn:hover {
      background: rgba(3,199,90,0.2);
      transform: scale(1.02);
    }
    .vin-candidate-btn.selected {
      background: #03c75a;
      color: #000;
    }
    .vin-status {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      margin-top: 4px;
      text-align: center;
    }
    .vin-status.valid {
      background: rgba(3,199,90,0.2);
      color: #03c75a;
    }
    .vin-status.invalid {
      background: rgba(229,57,53,0.2);
      color: #e53935;
    }
    .vin-status.partial {
      background: rgba(255,193,7,0.2);
      color: #ffc107;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(3,199,90,0.3);
      border-top: 4px solid #03c75a;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É</div>
    <div class="back-btn" onclick="window.location.href='index.html'">‚Üê –ù–∞–∑–∞–¥</div>
    <div class="form-card">
      <div class="form-row">
        <label for="vin-car">VIN –∞–≤—Ç–æ–º–æ–±—ñ–ª—è</label>
        <div class="input-wrapper">
          <input type="text" id="vin-car" maxlength="17" placeholder="–í–≤–µ–¥—ñ—Ç—å VIN –∞–≤—Ç–æ" required />
          <input type="file" id="vin-car-photo-input" accept="image/*" capture="environment" style="display:none;" />
          <div class="scan-btn" onclick="document.getElementById('vin-car-photo-input').click();" title="–°–∫–∞–Ω—É–≤–∞—Ç–∏ VIN –∑ —Ñ–æ—Ç–æ">üì∏</div>
          <div class="scan-btn" onclick="openLiveVinScanner('vin-car')" title="Live-—Å–∫–∞–Ω–µ—Ä VIN">üîç</div>
        </div>
        <div id="vin-car-status" class="vin-status" style="display:none;"></div>
      </div>
      <div class="form-row">
        <label for="vin-mceu">VIN –∑ –º–æ–Ω—ñ—Ç–æ—Ä—É –∞–≤—Ç–æ</label>
        <div class="input-wrapper">
          <input type="text" id="vin-mceu" maxlength="17" placeholder="–í–≤–µ–¥—ñ—Ç—å VIN –∑ –º–æ–Ω—ñ—Ç–æ—Ä—É –∞–≤—Ç–æ" required />
          <input type="file" id="vin-mceu-photo-input" accept="image/*" capture="environment" style="display:none;" />
          <div class="scan-btn" onclick="document.getElementById('vin-mceu-photo-input').click();" title="–°–∫–∞–Ω—É–≤–∞—Ç–∏ VIN –∑ —Ñ–æ—Ç–æ">üì∏</div>
          <div class="scan-btn" onclick="openLiveVinScanner('vin-mceu')" title="Live-—Å–∫–∞–Ω–µ—Ä VIN">üîç</div>
        </div>
        <div id="vin-mceu-status" class="vin-status" style="display:none;"></div>
      </div>
      <div class="form-row">
        <label for="problem">–û–ø–∏—Å –ø—Ä–æ–±–ª–µ–º–∏</label>
        <textarea id="problem" placeholder="–û–ø–∏—à—ñ—Ç—å –ø—Ä–æ–±–ª–µ–º—É" rows="4" required></textarea>
      </div>
      <div class="form-row">
        <label for="phone">–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É</label>
        <input type="tel" id="phone" placeholder="+380 XX XXX XX XX" required value="+380" maxlength="13" />
      </div>
      <div class="form-row file-row">
        <label for="file-input">–§–æ—Ç–æ / –≤—ñ–¥–µ–æ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
        <input type="file" id="file-input" name="media" accept="image/*,video/*" multiple style="color: white;" onchange="previewFiles()" />
        <div id="file-preview"></div>
      </div>
      <button id="submit-btn" class="submit-btn" onclick="submitForm()">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞—è–≤–∫—É</button>
    </div>
  </div>
  
  <!-- Live VIN Scanner Modal -->
  <div id="live-vin-modal" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.9);align-items:center;justify-content:center;flex-direction:column;">
    <div style="position:relative;width:100%;max-width:400px;">
      <video id="live-vin-video" autoplay playsinline style="width:100%;border:3px dashed #03c75a;border-radius:8px;background:#000;"></video>
      <div style="position:absolute;top:10px;left:0;width:100%;text-align:center;color:#fff;font-size:16px;text-shadow:0 2px 4px #000;">
        –ù–∞–≤–µ–¥—ñ—Ç—å —Ä–∞–º–∫—É –Ω–∞ VIN-–∫–æ–¥ (17 —Å–∏–º–≤–æ–ª—ñ–≤)
      </div>
    </div>
    <div id="live-vin-loading" class="loading-spinner" style="display:none;margin:16px auto;"></div>
    <input type="text" id="live-vin-result" maxlength="17" style="font-size:20px;padding:10px 16px;border-radius:8px;border:1px solid #03c75a;width:90%;max-width:320px;text-align:center;letter-spacing:2px;margin:16px 0 8px 0;display:none;" />
    <div style="display:flex;gap:10px;">
      <button id="live-vin-confirm-btn" class="submit-btn" style="background:#03c75a;display:none;">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
      <button id="live-vin-cancel-btn" class="submit-btn" style="background:#e53935;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è —Ñ–æ—Ç–æ-—Å–∫–∞–Ω–µ—Ä–∞ VIN -->
  <div id="vin-photo-modal" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.95);align-items:center;justify-content:center;flex-direction:column;">
    <div style="background:#222;padding:24px 16px;border-radius:16px;max-width:380px;width:95%;display:flex;flex-direction:column;align-items:center;">
      <div style="text-align:center;margin-bottom:16px;">
        <h3 style="margin:0 0 8px 0;color:#03c75a;">–°–∫–∞–Ω—É–≤–∞–Ω–Ω—è VIN</h3>
        <p style="margin:0;font-size:14px;color:#ccc;">–í–∏–±–µ—Ä—ñ—Ç—å –Ω–∞–π–∫—Ä–∞—â–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç –∞–±–æ –≤—ñ–¥—Ä–µ–¥–∞–≥—É–π—Ç–µ –≤—Ä—É—á–Ω—É</p>
      </div>
      
      <img id="vin-photo-preview" src="" alt="–§–æ—Ç–æ VIN" style="max-width:320px;max-height:120px;border-radius:8px;margin-bottom:16px;border:2px solid #03c75a;" />
      
      <div id="vin-photo-candidates" style="display:none;flex-wrap:wrap;gap:6px 8px;margin-bottom:12px;width:100%;justify-content:center;max-height:120px;overflow-y:auto;"></div>
      
      <input type="text" id="vin-photo-vin" maxlength="17" placeholder="–í–≤–µ–¥—ñ—Ç—å –∞–±–æ –≤—ñ–¥—Ä–µ–¥–∞–≥—É–π—Ç–µ VIN" style="font-size:18px;padding:12px 16px;border-radius:8px;border:2px solid #03c75a;width:100%;text-align:center;letter-spacing:1px;margin-bottom:12px;user-select:auto;background:#333;color:#fff;" />
      
      <div id="vin-photo-status" class="vin-status" style="display:none;margin-bottom:12px;"></div>
      
      <div style="display:flex;gap:10px;width:100%;">
        <button id="vin-photo-confirm-btn" class="submit-btn" style="background:#03c75a;flex:1;">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
        <button id="vin-photo-retry-btn" class="submit-btn" style="background:#e53935;flex:1;">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑</button>
      </div>
    </div>
  </div>
  
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    
    // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ VIN –≤ —Ç–µ–∫—Å—Ç–µ
    function findVinCandidates(text) {
      const candidates = [];
      
      // –ò—â–µ–º —Ç–æ—á–Ω—ã–µ 17-—Å–∏–º–≤–æ–ª—å–Ω—ã–µ VIN (—Ç–æ–ª—å–∫–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã)
      const exactMatches = text.match(/[A-HJ-NPR-Z0-9]{17}/gi) || [];
      candidates.push(...exactMatches.map(v => ({ vin: v.toUpperCase(), confidence: 'high' })));
      
      // –ò—â–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –æ—à–∏–±–∫–∞–º–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
      const cleanedText = text.replace(/[^A-Z0-9]/gi, '').toUpperCase();
      for (let i = 0; i <= cleanedText.length - 17; i++) {
        const candidate = cleanedText.slice(i, i + 17);
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ VIN (–Ω–µ –≤—Å–µ —Ü–∏—Ñ—Ä—ã, –Ω–µ –≤—Å–µ –±—É–∫–≤—ã)
        if (candidate.length === 17 && /[A-Z]/.test(candidate) && /[0-9]/.test(candidate)) {
          candidates.push({ vin: candidate, confidence: 'medium' });
        }
      }
      
      // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
      const uniqueCandidates = [];
      const seen = new Set();
      candidates.forEach(candidate => {
        if (!seen.has(candidate.vin)) {
          seen.add(candidate.vin);
          uniqueCandidates.push(candidate);
        }
      });
      
      return uniqueCandidates.slice(0, 5); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞–∫—Å–∏–º—É–º 5 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
    }
    
    // –§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ VIN
    function validateVin(vin) {
      if (!vin || vin.length !== 17) return 'invalid';
      if (!/^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) return 'invalid';
      return 'valid';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ VIN
    function updateVinStatus(fieldId, vin) {
      const statusElement = document.getElementById(fieldId + '-status');
      const validation = validateVin(vin);
      
      statusElement.style.display = 'block';
      statusElement.className = 'vin-status ' + validation;
      
      if (validation === 'valid') {
        statusElement.textContent = '‚úÖ VIN –≤–∞–ª—ñ–¥–Ω–∏–π';
      } else if (vin.length > 0 && vin.length < 17) {
        statusElement.textContent = '‚ö†Ô∏è –ù–µ–ø–æ–≤–Ω–∏–π VIN (' + vin.length + '/17)';
        statusElement.className = 'vin-status partial';
      } else {
        statusElement.textContent = '‚ùå –ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π VIN';
      }
    }
    
    // VIN —Å–∫–∞–Ω–µ—Ä —á–µ—Ä–µ–∑ —Ñ–æ—Ç–æ
    ['vin-car', 'vin-mceu'].forEach(function(field) {
      const inputId = field + '-photo-input';
      const input = document.getElementById(field);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–∏ –≤–≤–æ–¥–µ
      input.addEventListener('input', function() {
        updateVinStatus(field, this.value);
      });
      
      document.getElementById(inputId).addEventListener('change', function(e) {
        const file = this.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(ev) {
          document.getElementById('vin-photo-preview').src = ev.target.result;
          document.getElementById('vin-photo-modal').style.display = 'flex';
          document.getElementById('vin-photo-vin').value = '';
          document.getElementById('vin-photo-candidates').style.display = 'none';
          document.getElementById('vin-photo-candidates').innerHTML = '';
          document.getElementById('vin-photo-status').style.display = 'none';
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
          const loadingDiv = document.createElement('div');
          loadingDiv.className = 'loading-spinner';
          loadingDiv.style.margin = '16px auto';
          document.getElementById('vin-photo-modal').querySelector('div').appendChild(loadingDiv);
          
          // OCR —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º
          Tesseract.recognize(ev.target.result, 'eng', { 
            logger: m => console.log(m),
            tessedit_char_whitelist: 'ABCDEFGHJKLMNPRSTUVWXYZ0123456789'
          })
            .then(({ data: { text } }) => {
              // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
              loadingDiv.remove();
              
              const candidates = findVinCandidates(text);
              
              if (candidates.length > 0) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                document.getElementById('vin-photo-candidates').style.display = 'flex';
                document.getElementById('vin-photo-candidates').innerHTML = candidates.map((candidate, index) => 
                  `<button type='button' class='vin-candidate-btn ${index === 0 ? 'selected' : ''}' onclick='selectVinCandidate(\"${candidate.vin}\", this)'>${candidate.vin}</button>`
                ).join('');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–π –∫–∞–Ω–¥–∏–¥–∞—Ç –∫–∞–∫ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                document.getElementById('vin-photo-vin').value = candidates[0].vin;
                updateVinStatus('vin-photo', candidates[0].vin);
              } else {
                // Fallback: –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 17 —Å–∏–º–≤–æ–ª–æ–≤ –∏–∑ –æ—á–∏—â–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                const cleaned = text.replace(/[^A-Z0-9]/gi, '').toUpperCase().replace(/[IOQ]/g, '');
                const fallbackVin = cleaned.slice(0, 17);
                document.getElementById('vin-photo-vin').value = fallbackVin;
                updateVinStatus('vin-photo', fallbackVin);
              }
              
              document.getElementById('vin-photo-vin').focus();
            })
            .catch(err => {
              loadingDiv.remove();
              document.getElementById('vin-photo-vin').value = '';
              document.getElementById('vin-photo-status').style.display = 'block';
              document.getElementById('vin-photo-status').className = 'vin-status invalid';
              document.getElementById('vin-photo-status').textContent = '‚ùå –ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è';
            });
          
          // –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
          document.getElementById('vin-photo-confirm-btn').onclick = function() {
            const vin = document.getElementById('vin-photo-vin').value.trim().toUpperCase();
            const vinInput = document.getElementById(field);
            vinInput.value = vin;
            document.getElementById('vin-photo-modal').style.display = 'none';
            document.getElementById(inputId).value = '';
            vinInput.focus();
            updateVinStatus(field, vin);
            
            // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
            if (validateVin(vin) === 'valid') {
              vinInput.style.background = '#d4ffd4';
              setTimeout(() => { vinInput.style.background = ''; }, 2000);
            } else {
              vinInput.style.background = '#ffd4d4';
              setTimeout(() => { vinInput.style.background = ''; }, 2000);
            }
          };
          
          // –ö–Ω–æ–ø–∫–∞ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â–µ —Ä–∞–∑
          document.getElementById('vin-photo-retry-btn').onclick = function() {
            document.getElementById('vin-photo-modal').style.display = 'none';
            document.getElementById(inputId).value = '';
            document.getElementById(inputId).click();
          };
        };
        reader.readAsDataURL(file);
      });
    });
    
    // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ VIN
    function selectVinCandidate(vin, button) {
      // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
      document.querySelectorAll('.vin-candidate-btn').forEach(btn => btn.classList.remove('selected'));
      // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
      button.classList.add('selected');
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
      document.getElementById('vin-photo-vin').value = vin;
      updateVinStatus('vin-photo', vin);
    }
    
    let liveVinStream = null;
    let liveVinTarget = null;
    let liveVinInterval = null;
    
    function openLiveVinScanner(targetField) {
      liveVinTarget = targetField;
      document.getElementById('live-vin-modal').style.display = 'flex';
      document.getElementById('live-vin-result').style.display = 'none';
      document.getElementById('live-vin-confirm-btn').style.display = 'none';
      document.getElementById('live-vin-loading').style.display = 'block';
      
      const video = document.getElementById('live-vin-video');
      
      navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: { exact: 'environment' },
          width: { ideal: 1280 },
          height: { ideal: 720 }
        } 
      }).then((stream) => {
        liveVinStream = stream;
        video.srcObject = stream;
        video.play();
        
        liveVinInterval = setInterval(() => {
          if (video.readyState === 4) {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            Tesseract.recognize(canvas.toDataURL(), 'eng', { 
              logger: m => console.log(m),
              tessedit_char_whitelist: 'ABCDEFGHJKLMNPRSTUVWXYZ0123456789'
            })
              .then(({ data: { text } }) => {
                const candidates = findVinCandidates(text);
                if (candidates.length > 0) {
                  const vin = candidates[0].vin;
                  document.getElementById('live-vin-result').value = vin;
                  document.getElementById('live-vin-result').style.display = 'block';
                  document.getElementById('live-vin-confirm-btn').style.display = 'inline-block';
                  document.getElementById('live-vin-loading').style.display = 'none';
                  
                  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º, –µ—Å–ª–∏ VIN –≤–∞–ª–∏–¥–Ω—ã–π
                  if (validateVin(vin) === 'valid' && liveVinTarget) {
                    const vinInput = document.getElementById(liveVinTarget);
                    vinInput.value = vin;
                    updateVinStatus(liveVinTarget, vin);
                    vinInput.style.background = '#d4ffd4';
                    setTimeout(() => { vinInput.style.background = ''; }, 2000);
                    closeLiveVinScanner();
                  }
                }
              })
              .catch(err => {
                console.error(err);
              });
          }
        }, 2000); // –£–≤–µ–ª–∏—á–∏–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      }).catch(err => {
        alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ—Å—Ç–∏–π —Å–∫–∞–Ω–µ—Ä —á–µ—Ä–µ–∑ —Ñ–æ—Ç–æ.');
        document.getElementById('live-vin-modal').style.display = 'none';
      });
    }
    
    function closeLiveVinScanner() {
      document.getElementById('live-vin-modal').style.display = 'none';
      if (liveVinStream) {
        liveVinStream.getTracks().forEach(track => track.stop());
        liveVinStream = null;
      }
      if (liveVinInterval) {
        clearInterval(liveVinInterval);
        liveVinInterval = null;
      }
    }
    
    document.getElementById('live-vin-cancel-btn').onclick = closeLiveVinScanner;
    document.getElementById('live-vin-confirm-btn').onclick = function() {
      const vin = document.getElementById('live-vin-result').value.trim();
      if (vin.length >= 10 && liveVinTarget) {
        const vinInput = document.getElementById(liveVinTarget);
        vinInput.value = vin;
        updateVinStatus(liveVinTarget, vin);
        vinInput.style.background = '#d4ffd4';
        setTimeout(() => { vinInput.style.background = ''; }, 2000);
        closeLiveVinScanner();
      }
    };
    
    document.getElementById('live-vin-result').addEventListener('input', function() {
      this.value = this.value.replace(/[^A-Z0-9]/gi, '').replace(/[IOQ]/g, '').toUpperCase().slice(0, 17);
      if (this.value.length === 17 && liveVinTarget) {
        const vinInput = document.getElementById(liveVinTarget);
        vinInput.value = this.value;
        updateVinStatus(liveVinTarget, this.value);
        vinInput.style.background = '#d4ffd4';
        setTimeout(() => { vinInput.style.background = ''; }, 2000);
        closeLiveVinScanner();
      }
    });
    
    // –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ç–µ–ª–µ—Ñ–æ–Ω—É
    function validatePhone(phone) {
      return /^\+380\d{9}$/.test(phone);
    }
    
    const phoneInput = document.getElementById("phone");
    phoneInput.addEventListener("input", function(e) {
      if (!this.value.startsWith("+380")) {
        this.value = "+380" + this.value.replace(/[^\d]/g, "").replace(/^380/, "");
      }
      if (this.value.length > 13) {
        this.value = this.value.slice(0, 13);
      }
    });
    
    // –ü—Ä–µ–≤'—é —Ñ–∞–π–ª—ñ–≤
    function previewFiles() {
      const input = document.getElementById("file-input");
      const preview = document.getElementById("file-preview");
      preview.innerHTML = "";
      Array.from(input.files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function (e) {
          const container = document.createElement("div");
          container.style.position = "relative";
          container.style.maxWidth = "100px";
          container.style.maxHeight = "100px";
          const closeBtn = document.createElement("span");
          closeBtn.innerHTML = "√ó";
          closeBtn.onclick = () => removePreview(index);
          const element = document.createElement(file.type.startsWith('video') ? "video" : "img");
          element.src = e.target.result;
          element.style.maxWidth = "90px";
          element.style.maxHeight = "90px";
          if (file.type.startsWith('video')) { element.controls = true; }
          container.appendChild(element);
          container.appendChild(closeBtn);
          preview.appendChild(container);
        };
        reader.readAsDataURL(file);
      });
    }
    
    function removePreview(index) {
      const input = document.getElementById("file-input");
      const dt = new DataTransfer();
      const { files } = input;
      Array.from(files).forEach((file, i) => {
        if (i !== index) dt.items.add(file);
      });
      input.files = dt.files;
      previewFiles();
    }
    
    // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º–∏
    async function submitForm() {
      const vinCar = document.getElementById("vin-car").value.trim();
      const vinMceu = document.getElementById("vin-mceu").value.trim();
      const problem = document.getElementById("problem").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const chat_id = tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id ? String(tg.initDataUnsafe.user.id) : "unknown";
      const owner_name = tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.first_name ? tg.initDataUnsafe.user.first_name : "";
      
      if (!vinCar || !vinMceu || !problem || !phone) {
        tg.showPopup({
          title: "–ü–æ–º–∏–ª–∫–∞",
          message: "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è".slice(0, 64),
          buttons: [{ type: "ok" }]
        });
        return;
      }
      
      if (!validatePhone(phone)) {
        tg.showPopup({
          title: "–ü–æ–º–∏–ª–∫–∞",
          message: "–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É".slice(0, 64),
          buttons: [{ type: "ok" }]
        });
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å VIN
      if (validateVin(vinCar) !== 'valid') {
        tg.showPopup({
          title: "–ü–æ–º–∏–ª–∫–∞",
          message: "–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π VIN –∞–≤—Ç–æ–º–æ–±—ñ–ª—è".slice(0, 64),
          buttons: [{ type: "ok" }]
        });
        return;
      }
      
      if (validateVin(vinMceu) !== 'valid') {
        tg.showPopup({
          title: "–ü–æ–º–∏–ª–∫–∞",
          message: "–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π VIN –∑ –º–æ–Ω—ñ—Ç–æ—Ä—É –∞–≤—Ç–æ".slice(0, 64),
          buttons: [{ type: "ok" }]
        });
        return;
      }
      
      const botData = {
        vin: vinMceu,
        car_vin: vinCar,
        problem: problem,
        phone: phone,
        owner: "telegram",
        owner_name: owner_name,
        chat_id: chat_id
      };
      
      tg.sendData(JSON.stringify(botData));
      
      const form = new FormData();
      form.append("vin", vinMceu);
      form.append("car_vin", vinCar);
      form.append("problem", problem);
      form.append("phone", phone);
      form.append("owner", "telegram");
      form.append("owner_name", owner_name);
      form.append("chat_id", chat_id);
      
      const input = document.getElementById("file-input");
      for (let i = 0; i < input.files.length; i++) {
        form.append("media", input.files[i]);
      }
      
      fetch("https://tesla-service-dashboard-new-549c7415b70b.herokuapp.com/proxy_create_request", {
        method: "POST",
        body: form
      })
        .then(async res => {
          let text = await res.text();
          let data;
          try {
            data = JSON.parse(text);
          } catch {
            data = text;
          }
          if (res.ok) {
            tg.showPopup({
              title: "–£—Å–ø—ñ—Ö",
              message: String(typeof data === 'string' ? data : (data.message || "–ó–∞—è–≤–∫—É –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ!")).slice(0, 250),
              buttons: [{ type: "ok" }]
            });
            setTimeout(() => window.location.href = "history.html", 1500);
          } else {
            tg.showPopup({
              title: "–ü–æ–º–∏–ª–∫–∞ CRM",
              message: String(typeof data === 'string' ? data : (data.message || text)).slice(0, 250),
              buttons: [{ type: "ok" }]
            });
          }
        })
        .catch(error => {
          tg.showPopup({
            title: "–ü–æ–º–∏–ª–∫–∞",
            message: String(error && error.toString ? error.toString() : "–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞").slice(0, 250),
            buttons: [{ type: "ok" }]
          });
        });
    }
  </script>
</body>
</html>
