<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: url('tesla-bg.png') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      min-height: 100vh;
    }

    .container {
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }

    .page-header {
      font-size: 32px;
      text-align: center;
      margin-bottom: 24px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      margin-bottom: 20px;
      padding: 10px 20px;
      background: rgba(0,0,0,0.8);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: rgba(0,0,0,0.9);
      transform: translateY(-1px);
    }

    .form-card {
      background: rgba(0, 0, 0, 0.85);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
    }

    .form-row {
      margin-bottom: 20px;
      position: relative;
    }

    .form-row label {
      display: block;
      margin-bottom: 8px;
      color: #e0e0e0;
      font-size: 15px;
      font-weight: 500;
    }

    .input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-row input,
    .form-row textarea {
      flex: 1;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .form-row input:focus,
    .form-row textarea:focus {
      outline: none;
      border-color: #03c75a;
      background: rgba(255,255,255,0.08);
    }

    .scan-btn {
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(3,199,90,0.1);
      border: 1px solid rgba(3,199,90,0.3);
      border-radius: 10px;
      font-size: 20px;
      color: #03c75a;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .scan-btn:hover {
      background: rgba(3,199,90,0.2);
      transform: translateY(-1px);
    }

    .video-wrapper {
      display: none;
      flex-direction: column;
      align-items: center;
      margin: 20px 0;
      background: rgba(0,0,0,0.5);
      padding: 20px;
      border-radius: 12px;
    }

    video {
      width: 100%;
      max-height: 300px;
      border-radius: 8px;
    }

    canvas {
      display: none;
      width: 100%;
      max-height: 300px;
      border-radius: 8px;
    }

    .video-controls {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }

    .submit-btn {
      display: block;
      width: 100%;
      padding: 14px;
      margin-top: 24px;
      background: #03c75a;
      border: none;
      border-radius: 10px;
      color: #fff;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.3s ease;
    }

    .submit-btn:hover {
      background: #02b350;
      transform: translateY(-1px);
    }

    .submit-btn:disabled {
      background: #555;
      cursor: not-allowed;
    }

    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .loading.active {
      display: flex;
    }

    .loading-spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* New styles for multiple file upload */
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-input-label {
      display: block;
      padding: 12px 16px;
      background: rgba(255,255,255,0.05);
      border: 1px dashed rgba(255,255,255,0.2);
      border-radius: 10px;
      color: #ccc;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .file-input-label:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.3);
    }

    .selected-files {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .file-tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      background: rgba(3,199,90,0.1);
      border: 1px solid rgba(3,199,90,0.3);
      border-radius: 6px;
      font-size: 13px;
      color: #03c75a;
    }

    .file-tag .remove {
      margin-left: 6px;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .file-tag .remove:hover {
      opacity: 1;
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É</div>

    <div class="back-btn" onclick="window.location.href='index.html'">‚Üê –ù–∞–∑–∞–¥</div>

    <div class="form-card">
      <div class="form-row">
        <label for="vin-car">VIN –∞–≤—Ç–æ–º–æ–±—ñ–ª—è</label>
        <div class="input-wrapper">
          <input type="text" id="vin-car" placeholder="–í–≤–µ–¥—ñ—Ç—å VIN –∞–≤—Ç–æ" required />
          <div class="scan-btn">üì∏</div>
        </div>
      </div>

      <div class="form-row">
        <label for="vin-ecu">VIN –±–ª–æ–∫—É –∫–µ—Ä—É–≤–∞–Ω–Ω—è (ECU)</label>
        <div class="input-wrapper">
          <input type="text" id="vin-ecu" placeholder="–í–≤–µ–¥—ñ—Ç—å VIN ECU" required />
          <div class="scan-btn">üì∏</div>
        </div>
      </div>

      <div class="form-row">
        <label for="problem">–û–ø–∏—Å –ø—Ä–æ–±–ª–µ–º–∏</label>
        <textarea id="problem" placeholder="–û–ø–∏—à—ñ—Ç—å –ø—Ä–æ–±–ª–µ–º—É" rows="4" required></textarea>
      </div>

      <div class="form-row">
        <label for="phone">–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É</label>
        <input type="tel" id="phone" placeholder="+380 XX XXX XX XX" required />
      </div>

      <!-- File Input with multiple support -->
      <div class="form-row">
        <label for="file-input">–§–æ—Ç–æ / –≤—ñ–¥–µ–æ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
        <div class="file-input-wrapper">
          <div class="file-input-label" id="file-label">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É —Ñ–∞–π–ª—ñ–≤</div>
          <input id="file-input" type="file" accept="image/*,video/*" onchange="updateFileLabel()" multiple />
        </div>
        <div id="selected-files" class="selected-files"></div>
      </div>

      <button id="submit-btn" class="submit-btn" onclick="submitForm()" disabled>–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞—è–≤–∫—É</button>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const fields = [
      document.getElementById("vin-car"),
      document.getElementById("vin-ecu"),
      document.getElementById("problem"),
      document.getElementById("phone")
    ];
    const btn = document.getElementById("submit-btn");
    const loading = document.getElementById("loading");

    function checkFields() {
      const allFilled = fields.every(field => field.value.trim() !== "");
      btn.disabled = !allFilled;
    }

    fields.forEach(field => field.addEventListener("input", checkFields));

    function validatePhone(phone) {
      // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ regex)
      const regex = /^\+?\d{10,15}$/;
      return regex.test(phone);
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ ---
    function updateFileLabel() {
      const fileInput = document.getElementById("file-input");
      const label = document.getElementById("file-label");
      const selectedFiles = document.getElementById("selected-files");
      
      // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
      selectedFiles.innerHTML = '';
      
      if (fileInput.files.length > 0) {
        label.textContent = `–í–∏–±—Ä–∞–Ω–æ —Ñ–∞–π–ª—ñ–≤: ${fileInput.files.length}`;
        
        // –°–æ–∑–¥–∞–µ–º —Ç–µ–≥–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        Array.from(fileInput.files).forEach((file, index) => {
          const fileTag = document.createElement('div');
          fileTag.className = 'file-tag';
          fileTag.innerHTML = `
            ${file.name}
            <span class="remove" onclick="removeFile(${index})">√ó</span>
          `;
          selectedFiles.appendChild(fileTag);
        });
      } else {
        label.textContent = "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É —Ñ–∞–π–ª—ñ–≤";
      }
    }

    function removeFile(index) {
      const fileInput = document.getElementById("file-input");
      const dt = new DataTransfer();
      const files = fileInput.files;
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π FileList –±–µ–∑ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
      for (let i = 0; i < files.length; i++) {
        if (i !== index) {
          dt.items.add(files[i]);
        }
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º input —Å –Ω–æ–≤—ã–º FileList
      fileInput.files = dt.files;
      updateFileLabel();
      checkFields(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—è –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ —Ñ–∞–π–ª –±—ã–ª –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º, —ç—Ç–æ –Ω—É–∂–Ω–æ)
    }
    // ------------------------------------

    async function submitForm() {
      const vinCar = fields[0].value.trim();
      const vinEcu = fields[1].value.trim();
      const problem = fields[2].value.trim();
      const phone = fields[3].value.trim();
      const chat_id = String(tg.initDataUnsafe.user.id);
      const owner_name = tg.initDataUnsafe.user.first_name || "";

      if (!vinCar || !vinEcu || !problem || !phone) {
        tg.showPopup({
          title: "–ü–æ–º–∏–ª–∫–∞",
          message: "–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è",
          buttons: [{ type: "ok" }]
        });
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      if (!validatePhone(phone)) {
        tg.showPopup({
          title: "–ü–æ–º–∏–ª–∫–∞",
          message: "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É",
          buttons: [{ type: "ok" }]
        });
        return;
      }

      loading.classList.add("active");
      btn.disabled = true;

      try {
        console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏...", {
          vin: vinEcu,
          car_vin: vinCar,
          problem: problem,
          phone: phone,
          owner: "telegram",
          owner_name: owner_name,
          chat_id: chat_id
        });

        const form = new FormData();
        form.append("vin", vinEcu);
        form.append("car_vin", vinCar);
        form.append("problem", problem);
        form.append("phone", phone);
        form.append("owner", "telegram");
        form.append("owner_name", owner_name);
        form.append("chat_id", chat_id);

        const fileInput = document.getElementById("file-input");
        if (fileInput.files.length > 0) {
          console.log("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤:", fileInput.files.length);
          for (let i = 0; i < fileInput.files.length; i++) {
            form.append("media", fileInput.files[i]);
            console.log(`–î–æ–±–∞–≤–ª–µ–Ω —Ñ–∞–π–ª ${i + 1}: ${fileInput.files[i].name}`);
          }
        }

        const res = await fetch("https://tesla-service-dashboard-eda44e4816de.herokuapp.com/api/create_request", {
          method: "POST",
          body: form
        });

        console.log("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", res.status, res.statusText);
        const result = await res.json();
        console.log("–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:", result);
        
        if (result.status === "ok") {
          tg.showPopup({
            title: "–£—Å–ø—ñ—Ö!",
            message: "–ó–∞—è–≤–∫–∞ —É—Å–ø—ñ—à–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–∞!",
            buttons: [{ type: "ok" }]
          });
          setTimeout(() => window.location.href = "history.html", 1500);
        } else {
          console.error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:", result);
          throw new Error(result.message || "–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –∑–∞—è–≤–∫–∏");
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:", error);
        tg.showPopup({
          title: "–ü–æ–º–∏–ª–∫–∞",
          message: error.message || "–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –∑–∞—è–≤–∫–∏. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.",
          buttons: [{ type: "ok" }]
        });
        btn.disabled = false;
      } finally {
        loading.classList.remove("active");
      }
    }

    // Initialize check on load
    checkFields();
  </script>
</body>
</html>
